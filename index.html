<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard â€” Income & Expense</title>

<style>
  :root{
    --bg:#0b1220;
    --card:#111b2e;
    --muted:#9aa4b2;
    --accent:#38bdf8;
    --accent-2:#60a5fa;
  }

  body{
    font-family: 'Inter', system-ui, Arial;
    margin:18px;
    background:linear-gradient(160deg,#0b1220,#091426,#071120);
    color:#e6eef6;
  }

  header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:16px;
    padding-bottom:10px;
    border-bottom:1px solid rgba(255,255,255,0.06);
  }

  header h2{
    font-weight:600;
    background:linear-gradient(90deg,var(--accent),#7dd3fc);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    display: inline-block;
    margin:0;
  }

  nav a{
    color:var(--muted);
    text-decoration:none;
    margin:0 6px;
    font-size:14px;
  }
  nav a:hover{
    color:var(--accent);
  }

  .card{
    background:rgba(255,255,255,0.04);
    backdrop-filter:blur(8px);
    padding:18px;
    border-radius:14px;
    margin-bottom:16px;
    box-shadow:0 2px 10px rgba(0,0,0,0.3);
  }

  .row{display:flex;gap:12px;flex-wrap:wrap}
  .box{
    flex:1;
    padding:14px;
    border-radius:10px;
    background:rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.08);
    transition:transform .2s, background .3s;
    min-width:160px;
  }
  .box:hover{
    transform:translateY(-2px);
    background:rgba(255,255,255,0.08);
  }

  button{
    padding:8px 12px;
    border-radius:8px;
    border:none;
    cursor:pointer;
    background:linear-gradient(90deg,var(--accent-2),var(--accent));
    color:#fff;
    font-size:13px;
    transition:opacity .2s,transform .2s;
  }
  button:hover{
    opacity:0.9;
    transform:translateY(-1px);
  }

  input[type=file]::file-selector-button{
    display:none;
  }

  canvas{
    border-radius:10px;
    background:#0b142a;
    border:1px solid rgba(255,255,255,0.05);
  }

  ::placeholder{
    color:#5f6b85;
  }

  #bankList div:hover{
    background:rgba(255,255,255,0.03);
  }
</style>
</head>
<body>
  <header>
    <h2>ðŸ’¹ Income & Expense â€” Dashboard</h2>
    <nav>
      <a href="index.html">Dashboard</a> |
      <a href="banks.html">Banks</a> |
      <a href="transactions.html">Transactions</a>
    </nav>
  </header>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong style="font-size:16px;">Overview</strong>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button id="btnExport">Export JSON</button>
        <input id="fileIn" type="file" accept="application/json" style="display:none">
        <button id="btnImport">Import JSON</button>
        <button id="btnReset" style="background:linear-gradient(90deg,#ef4444,#f87171)">Reset</button>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="box">
        <div style="font-size:12px;color:var(--muted)">Total Income</div>
        <div id="income" style="font-weight:700;font-size:22px">â‚¹0</div>
      </div>
      <div class="box">
        <div style="font-size:12px;color:var(--muted)">Total Expense</div>
        <div id="expense" style="font-weight:700;font-size:22px">â‚¹0</div>
      </div>
      <div class="box">
        <div style="font-size:12px;color:var(--muted)">Net</div>
        <div id="net" style="font-weight:700;font-size:22px">â‚¹0</div>
      </div>
    </div>

    <!-- Today's boxes (new) -->
    <div class="row" style="margin-top:12px">
      <div class="box">
        <div style="font-size:12px;color:var(--muted)">Today's Income</div>
        <div id="todayIncome" style="font-weight:700;font-size:22px">â‚¹0</div>
      </div>
      <div class="box">
        <div style="font-size:12px;color:var(--muted)">Today's Expense</div>
        <div id="todayExpense" style="font-weight:700;font-size:22px">â‚¹0</div>
      </div>
      <div class="box">
        <div style="font-size:12px;color:var(--muted)">Today's Net</div>
        <div id="todayNet" style="font-weight:700;font-size:22px">â‚¹0</div>
      </div>
    </div>
  </div>

  <div class="card">
    <strong style="font-size:16px;">Balances by Bank</strong>
    <div id="bankList" style="margin-top:10px;font-size:14px"></div>
  </div>

  <div class="card">
    <strong style="font-size:16px;">Charts</strong>
    <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
      <canvas id="chartBar" width="600" height="200"></canvas>
      <canvas id="chartPie" width="200" height="200"></canvas>
    </div>
    <div style="margin-top:8px;text-align:center;color:var(--muted);font-size:13px">
      Created with Â© Copyright Subair V M
    </div>
  </div>

<script src="data.js"></script>
<script>
  // small helpers used by this page
  function el(id){ return document.getElementById(id); }

  function fmtAmt(n){
    n = Number(n) || 0;
    const fixed = (Math.abs(n % 1) < 0.000001) ? String(Math.round(n)) : n.toFixed(2);
    return 'â‚¹' + fixed.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // robust local-date-equality: compares year/month/date in local timezone
  function isSameLocalDate(isoOrAny){
    if(!isoOrAny) return false;
    const d = new Date(isoOrAny);
    if(isNaN(d.getTime())) return false;
    const now = new Date();
    return d.getFullYear() === now.getFullYear() &&
           d.getMonth() === now.getMonth() &&
           d.getDate() === now.getDate();
  }

  function render(){
    // totals (global)
    const totals = (typeof DataStore.totals === 'function') ? DataStore.totals() : { income:0, expense:0, net:0 };
    el('income').textContent = fmtAmt(totals.income);
    el('expense').textContent = fmtAmt(totals.expense);
    el('net').textContent = fmtAmt(totals.net);

    // today totals (scan all txns; ignore transfers)
    const txns = (typeof DataStore.listTxns === 'function') ? DataStore.listTxns() : (DataStore.getState && DataStore.getState().txns ? DataStore.getState().txns.slice() : []);
    let todayIncome = 0, todayExpense = 0;
    txns.forEach(t=>{
      if(!t || !t.type) return;
      if(!isSameLocalDate(t.date)) return;
      if(t.type === 'income') todayIncome += Number(t.amount) || 0;
      else if(t.type === 'expense') todayExpense += Number(t.amount) || 0;
    });
    el('todayIncome').textContent = fmtAmt(todayIncome);
    el('todayExpense').textContent = fmtAmt(todayExpense);
    el('todayNet').textContent = fmtAmt(todayIncome - todayExpense);

    // banks list
    const banks = (typeof DataStore.balancesPerBank === 'function') ? DataStore.balancesPerBank() : [];
    const list = el('bankList'); list.innerHTML = '';
    banks.forEach(b=>{
      const d = document.createElement('div');
      d.style.padding = '10px';
      d.style.display = 'flex';
      d.style.justifyContent = 'space-between';
      d.style.borderBottom = '1px dashed rgba(255,255,255,0.05)';
      const muted = getComputedStyle(document.documentElement).getPropertyValue('--muted') || '#9aa4b2';
      d.innerHTML = `<div><strong>${escapeHtml(b.name)}</strong><div style='font-size:12px;color:${muted}'>${b.count} txns</div></div>
                     <div style='text-align:right'><div>${fmtAmt(b.balance)}</div><div style='font-size:12px;color:${muted}'>inc ${fmtAmt(b.income)} â€¢ exp ${fmtAmt(b.expense)}</div></div>`;
      list.appendChild(d);
    });

    drawCharts(banks);
  }

  // simple bar + pie charts (keeps original behaviour)
  function drawCharts(banks){
    // bar chart (balances)
    const c = document.getElementById('chartBar'), ctx = c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    const pad = 30, w = c.width - pad*2, h = c.height - pad*2;
    const vals = banks.map(b=>b.balance), labels = banks.map(b=>b.name);
    const max = Math.max(1, ...vals.map(v=>Math.abs(v)));
    const barW = Math.max(8, Math.floor(w / Math.max(1, vals.length)) - 6);
    ctx.textAlign = 'left';
    vals.forEach((v,i)=>{
      const x = pad + i*(barW + 6);
      const barH = (Math.abs(v) / max) * (h - 20);
      const y = pad + (v >= 0 ? (h - barH) : h);
      ctx.fillStyle = v >= 0 ? '#10b981' : '#ef4444';
      ctx.fillRect(x, y, barW, barH);
      ctx.fillStyle = '#9aa4b2';
      ctx.font = '10px Arial';
      ctx.fillText(labels[i].slice(0,10), x, pad + h + 12);
    });

    // pie chart of income by bank
    const c2 = document.getElementById('chartPie'), p = c2.getContext('2d');
    p.clearRect(0,0,c2.width,c2.height);
    const incs = banks.map(b=>b.income), totalInc = incs.reduce((s,x)=>s+x,0) || 1;
    let start = -Math.PI/2, cx = c2.width/2, cy = c2.height/2, r = Math.min(cx,cy) - 8;
    incs.forEach((v,i)=>{
      const ang = (v/totalInc) * Math.PI * 2;
      p.beginPath(); p.moveTo(cx,cy);
      p.arc(cx,cy,r,start,start+ang);
      p.closePath();
      p.fillStyle = `hsl(${(i*45) % 360} 70% 50%)`;
      p.fill(); start += ang;
    });
  }

  // export / import / reset handlers
  el('btnExport').addEventListener('click', ()=>{
    try{
      const blob = new Blob([DataStore.exportJSON()], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'ie-data.json'; a.click();
      URL.revokeObjectURL(url);
    }catch(e){ alert('Export failed'); console.error(e); }
  });

  el('btnImport').addEventListener('click', ()=> el('fileIn').click());

  el('fileIn').addEventListener('change', async ev => {
    const f = ev.target.files[0]; if(!f) return;
    try{
      const txt = await f.text();
      const parsed = JSON.parse(txt);
      // DataStore.importFrom expects { banks: [...], txns: [...] }
      if(!parsed || !Array.isArray(parsed.banks) || !Array.isArray(parsed.txns)){
        alert('Invalid file: expected banks & txns arrays');
        return;
      }
      if(!confirm('Import replaces current data. Continue?')) return;
      DataStore.importFrom(parsed);
      render();
      alert('Imported successfully');
    }catch(e){ console.error(e); alert('Import failed'); }
    // clear the input so same file can be reselected if needed
    ev.target.value = '';
  });

  el('btnReset').addEventListener('click', ()=> {
    if(confirm('Reset all data to defaults? This cannot be undone.')){
      DataStore.resetToDefault();
      render();
    }
  });

  // initial render & refresh when tab focused
  render();
  window.addEventListener('focus', render);
</script>
</body>
</html>
